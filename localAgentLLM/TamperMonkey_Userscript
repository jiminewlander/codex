// ==UserScript==
// @name         OWA Capture to Local Digest
// @namespace    local-agent
// @version      0.1
// @description  Capture current Outlook Web email into localhost agent inbox
// @match        https://outlook.office.com/*
// @match        https://outlook.office365.us/*
// @match        https://outlook-dod.office365.us/*
// @grant        GM_xmlhttpRequest
// @connect      127.0.0.1
// @connect      localhost
// ==/UserScript==

(function () {
  "use strict";

  const API_BASE = "http://127.0.0.1:8089";
  const AGENT_KEY = "CHANGE_ME_TO_SOMETHING_RANDOM";

  function text(el) {
    if (!el) return "";
    return (el.innerText || el.textContent || "").trim();
  }

  function firstBySelectors(selectors) {
    for (const sel of selectors) {
      const el = document.querySelector(sel);
      if (el && text(el)) return el;
    }
    return null;
  }

  function extractEmail() {
    // Subject candidates
    const subjectEl = firstBySelectors([
      'div[role="heading"]',
      '[data-testid="message-subject"]',
      'span[role="heading"]',
      'h1, h2'
    ]);

    // From candidates
    const fromEl = firstBySelectors([
      '[data-testid="message-from"]',
      'span[title][data-log-name*="From"]',
      'span[aria-label^="From"]',
      'div[aria-label^="From"]'
    ]);

    // Time candidates
    const timeEl = firstBySelectors([
      'time',
      '[data-testid="message-receivedTime"]',
      'span[aria-label*="Received"]',
      'span[aria-label*="Sent"]'
    ]);

    // Body candidates
    const bodyEl = firstBySelectors([
      'div[role="document"]',
      'div[aria-label="Message body"]',
      'div[data-testid="message-body"]',
      'div[role="main"] div[dir="ltr"]'
    ]);

    const subject = subjectEl ? text(subjectEl) : (document.title || "").replace(" - Outlook", "").trim();
    const from = fromEl ? text(fromEl) : "";
    const received = timeEl ? (timeEl.getAttribute("datetime") || text(timeEl)) : "";
    let body = bodyEl ? text(bodyEl) : "";

    // Fallback: take a big readable chunk from main content
    if (!body) {
      const main = document.querySelector('div[role="main"]') || document.body;
      body = text(main).slice(0, 12000);
    }

    return {
      source: "owa",
      subject,
      from,
      received,
      body,
      url: location.href
    };
  }

  function postIngest(payload) {
    return new Promise((resolve, reject) => {
      GM_xmlhttpRequest({
        method: "POST",
        url: `${API_BASE}/ingest`,
        headers: {
          "Content-Type": "application/json",
          "X-Agent-Key": AGENT_KEY
        },
        data: JSON.stringify(payload),
        onload: (resp) => {
          if (resp.status >= 200 && resp.status < 300) resolve(resp.responseText);
          else reject(new Error(`HTTP ${resp.status}: ${resp.responseText}`));
        },
        onerror: (err) => reject(err)
      });
    });
  }

  function toast(msg, isError=false) {
    const t = document.createElement("div");
    t.textContent = msg;
    t.style.position = "fixed";
    t.style.right = "16px";
    t.style.bottom = "16px";
    t.style.zIndex = 999999;
    t.style.padding = "10px 12px";
    t.style.borderRadius = "10px";
    t.style.background = isError ? "#b00020" : "#1b5e20";
    t.style.color = "white";
    t.style.fontSize = "13px";
    t.style.boxShadow = "0 6px 20px rgba(0,0,0,0.25)";
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2600);
  }

  function addButton() {
    if (document.getElementById("owaCaptureBtn")) return;

    const btn = document.createElement("button");
    btn.id = "owaCaptureBtn";
    btn.textContent = "Capture to Digest";
    btn.style.position = "fixed";
    btn.style.right = "16px";
    btn.style.top = "16px";
    btn.style.zIndex = 999999;
    btn.style.padding = "10px 12px";
    btn.style.borderRadius = "12px";
    btn.style.border = "0";
    btn.style.cursor = "pointer";
    btn.style.background = "#111";
    btn.style.color = "#fff";
    btn.style.fontSize = "13px";
    btn.style.boxShadow = "0 6px 20px rgba(0,0,0,0.25)";

    btn.addEventListener("click", async () => {
      try {
        const payload = extractEmail();
        if (!payload.subject && !payload.body) {
          toast("Could not detect an open email", true);
          return;
        }
        await postIngest(payload);
        toast("Captured âœ…");
      } catch (e) {
        toast(`Capture failed: ${e.message}`, true);
        console.error(e);
      }
    });

    document.body.appendChild(btn);
  }

  // OWA is an SPA, so re add button on navigation
  const obs = new MutationObserver(() => addButton());
  obs.observe(document.documentElement, { childList: true, subtree: true });

  addButton();
})();